{
  "query": {
    "bool": {
      "filter": [
        {
          "range": {
            "start_timestamp": {
              "gte": "now-10d/d",
              "lte": "now"
            }
          }
        },
        {
          "exists": { "field": "end_timestamp" }
        }
      ]
    }
  },
  "aggs": {
    "avg_duration": {
      "scripted_metric": {
        "init_script": "state.durations = []",
        "map_script": """
          if (doc.containsKey('start_timestamp') && doc.containsKey('end_timestamp') &&
              !doc['start_timestamp'].empty && !doc['end_timestamp'].empty) {
            def duration = (doc['end_timestamp'].value.toInstant().toEpochMilli() -
                            doc['start_timestamp'].value.toInstant().toEpochMilli()) / 60000.0;
            state.durations.add(duration);
          }
        """,
        "combine_script": "return state.durations",
        "reduce_script": """
          double total = 0;
          int count = 0;
          for (a in states) {
            for (d in a) {
              total += d;
              count++;
            }
          }
          return count > 0 ? total / count : 0;
        """
      }
    }
  }
}
