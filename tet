#!/bin/bash

input_directory="input_directory"
output_directory="output_directory"

process_file() {
    input_file="$1"
    output_file="$2"

    awk -v OFS='|' '
    BEGIN { FS="," }
    {
        for (i = 1; i < NF; i++) {
            gsub(/\n/, "", $i)
            gsub(/"/, "", $i)
        }
        $NF = gensub(/"/, "", "g", $NF)
        print $0
    }' "$input_file" > "$output_file"
}

while true; do
    for filepath in "$input_directory"/*.csv; do
        if [ -f "$filepath" ]; then
            filename=$(basename "$filepath")
            output_filepath="$output_directory/processed_$filename"

            process_file "$filepath" "$output_filepath"

            # Move processed file to avoid reprocessing
            mv "$filepath" "$input_directory/processed_$filename"
        fi
    done

    # Wait for 5 minutes
    sleep 300
done
