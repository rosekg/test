import pandas as pd

def extract_wf_predecessors_with_runas(df):
    # Step 1: Combine Jobname and RunAs info
    df['Job_RunAs'] = df['Jobname'] + '|' + df['RunAs']

    # Step 2: Split Predecessor column and explode
    df_exploded = df.assign(
        Predecessor=df['Predecessor'].str.split('|')
    ).explode('Predecessor')

    # Step 3: Filter rows containing 'WF' or 'WORKFLOW'
    df_filtered = df_exploded[
        df_exploded['Predecessor'].str.contains(r'\b(WF|WORKFLOW)', case=False, na=False)
    ]

    # Step 4: Rename and group by WF predecessor
    df_filtered = df_filtered.rename(columns={'Predecessor': 'WF_Pred'})
    grouped = df_filtered.groupby('WF_Pred')['Job_RunAs'].apply(list).reset_index()

    # Step 5: Spread to multiple columns
    max_jobs = grouped['Job_RunAs'].apply(len).max()
    for i in range(max_jobs):
        grouped[f'Job_{i+1}'] = grouped['Job_RunAs'].apply(lambda x: x[i] if i < len(x) else None)

    return grouped.drop(columns='Job_RunAs')
