#!/bin/bash

input_directory="input_directory"
output_directory="output_directory"

process_file() {
    input_file="$1"
    output_file="$2"

    while IFS= read -r line || [ -n "$line" ]; do
        # Remove quotes and newlines from fields except the last one
        fields=$(echo "$line" | awk -v RS=',' -v ORS='|' 'NR < NF {gsub(/"/, ""); gsub(/\n/, ""); print}')
        
        # Process the last field separately to preserve internal commas
        last_field=$(echo "$line" | awk -F',' '{gsub(/"/, "", $NF); gsub(/\n/, "", $NF); print $NF}')

        # Combine and output the processed line
        echo "${fields}${last_field}" >> "$output_file"
    done < "$input_file"
}

while true; do
    for filepath in "$input_directory"/*.csv; do
        if [ -f "$filepath" ]; then
            filename=$(basename "$filepath")
            output_filepath="$output_directory/processed_$filename"

            process_file "$filepath" "$output_filepath"

            # Move processed file to avoid reprocessing
            mv "$filepath" "$input_directory/processed_$filename"
        fi
    done

    # Wait for 5 minutes
    sleep 300
done
