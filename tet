import requests
import csv
from bs4 import BeautifulSoup

# Rundeck API endpoint and authentication details
rundeck_url = "http://your-rundeck-instance/api/32"
api_token = "your-api-token"

# Headers for API requests
headers = {
    "Content-Type": "application/json",
    "X-Rundeck-Auth-Token": api_token
}

# Function to retrieve job information from Rundeck
def get_job_info():
    # API endpoint for job listing
    job_list_url = f"{rundeck_url}/projects/YOUR_PROJECT_NAME/jobs"

    try:
        response = requests.get(job_list_url, headers=headers)
        if response.status_code == 200:
            job_data = response.json()
            job_info = []

            for job in job_data:
                permalink_url = job["permalink"]
                job_response = requests.get(permalink_url, headers=headers)
                job_soup = BeautifulSoup(job_response.text, "html.parser")
                job_name = job_soup.select_one(".job-header .title").text.strip()
                job_description = job_soup.select_one(".job-description").text.strip()
                job_run_time = job_soup.select_one(".job-metric .duration").text.strip()
                job_nodes = job_soup.select(".job-node-name")

                nodes = [node.text.strip() for node in job_nodes]

                job_info.append([job_name, job_description, job_run_time, nodes])

            # Save job info as CSV
            with open("job_info.csv", mode="w", newline="") as file:
                writer = csv.writer(file)
                writer.writerow(["Job Name", "Job Description", "Run Time", "Nodes"])
                writer.writerows(job_info)

            print("Job information saved as job_info.csv")
        else:
            print(f"Error: {response.status_code} - {response.text}")
    except requests.exceptions.RequestException as e:
        print(f"Error: {e}")

# Call the function to retrieve job information and save as CSV
get_job_info()
